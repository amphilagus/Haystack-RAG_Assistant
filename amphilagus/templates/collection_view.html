{% extends "base.html" %}

{% block title %}{{ collection.name }} - 集合详情{% endblock %}

{% block styles %}
<style>
    .collection-header {
        background-color: #f8f9fa;
        padding: 1.5rem;
        border-radius: 0.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    }
    .collection-title {
        margin-bottom: 0.5rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    .collection-description {
        color: #6c757d;
        margin-bottom: 1rem;
    }
    .collection-metadata {
        font-size: 0.875rem;
        color: #6c757d;
    }
    .doc-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 1rem;
    }
    .doc-table th, .doc-table td {
        padding: 0.75rem;
        vertical-align: middle;
    }
    .doc-table tbody tr:hover {
        background-color: rgba(0, 123, 255, 0.05);
    }
    .doc-preview {
        max-height: 4rem;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        max-width: 300px;
    }
    .doc-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 0.25rem;
    }
    .doc-tag {
        background-color: #e9ecef;
        color: #495057;
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        font-size: 0.75rem;
    }
    .stat-card {
        padding: 1rem;
        background-color: #ffffff;
        border-radius: 0.5rem;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        text-align: center;
        height: 100%;
    }
    .stat-card .number {
        font-size: 2rem;
        font-weight: 600;
        color: #0d6efd;
    }
    .stat-card .label {
        font-size: 0.875rem;
        color: #6c757d;
    }
    .upload-section {
        margin-top: 2rem;
        padding: 1.5rem;
        background-color: #f8f9fa;
        border-radius: 0.5rem;
    }
    .drop-zone {
        border: 2px dashed #0d6efd;
        border-radius: 0.5rem;
        padding: 2rem;
        text-align: center;
        cursor: pointer;
        transition: background-color 0.3s;
    }
    .drop-zone:hover {
        background-color: rgba(13, 110, 253, 0.05);
    }
    .drop-zone.dragover {
        background-color: rgba(13, 110, 253, 0.1);
    }
    .drop-zone__input {
        display: none;
    }
    .file-preview-container {
        margin-top: 1rem;
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
    }
    .file-preview-item {
        position: relative;
        padding: 0.5rem;
        border: 1px solid #dee2e6;
        border-radius: 0.25rem;
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 100px;
        text-align: center;
    }
    .file-preview-item i {
        font-size: 2rem;
        margin-bottom: 0.5rem;
    }
    .file-preview-name {
        font-size: 0.75rem;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        width: 100%;
    }
    .file-preview-size {
        font-size: 0.675rem;
        color: #6c757d;
    }
    .file-preview-remove {
        position: absolute;
        top: -8px;
        right: -8px;
        background-color: #dc3545;
        color: white;
        border: none;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        font-size: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
    }
    .upload-progress-container {
        margin-top: 1rem;
        display: none;
    }
    .progress {
        height: 0.5rem;
    }
    .tags-input-container {
        background-color: #fff;
        border: 1px solid #ced4da;
        border-radius: 0.25rem;
        padding: 0.25rem 0.5rem;
        display: flex;
        flex-wrap: wrap;
        gap: 0.25rem;
        min-height: 38px;
    }
    .tag-item {
        background-color: #e9ecef;
        color: #212529;
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }
    .tag-item .remove-tag {
        cursor: pointer;
        font-size: 0.75rem;
    }
    .tags-input {
        flex: 1;
        border: none;
        outline: none;
        padding: 0.25rem 0;
        min-width: 50px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- 顶部导航 -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('index') }}">首页</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('database_dashboard') }}">数据库管理</a></li>
            <li class="breadcrumb-item active" aria-current="page">{{ collection.name }}</li>
        </ol>
    </nav>

    <!-- 成功/错误消息 -->
    {% if success %}
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        {{ success }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endif %}
    {% if error %}
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        {{ error }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endif %}

    <!-- 集合信息 -->
    <div class="collection-header">
        <div class="collection-title">
            <h1>{{ collection.name }}</h1>
            <div>
                <button class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#editCollectionModal">
                    <i class="fas fa-edit"></i> 编辑
                </button>
                <button class="btn btn-outline-danger btn-sm" data-bs-toggle="modal" data-bs-target="#deleteCollectionModal">
                    <i class="fas fa-trash"></i> 删除
                </button>
            </div>
        </div>
        <div class="collection-description">
            {% if collection.description %}
            {{ collection.description }}
            {% else %}
            <em>暂无描述</em>
            {% endif %}
        </div>
        <div class="collection-metadata">
            <strong>嵌入模型:</strong> {{ collection.embedding_model }} | 
            <strong>创建时间:</strong> {{ collection.creation_time|datetimeformat('%Y-%m-%d %H:%M') }}
        </div>
    </div>

    <!-- 统计信息 -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="stat-card">
                <div class="number">{{ collection.document_count }}</div>
                <div class="label">文档数量</div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="stat-card">
                <div class="number">{{ collection.unique_tags|length }}</div>
                <div class="label">唯一标签</div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="stat-card">
                <div class="number">{{ collection.unique_titles|default(0) }}</div>
                <div class="label">文档标题数</div>
            </div>
        </div>
    </div>

    <!-- 文档管理 -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">文档管理</h5>
        </div>
        <div class="card-body">
            {% if documents %}
                {% for title, title_docs in documents_by_title.items() %}
                <div class="card mb-3">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">{{ title }}</h5>
                        <small class="text-muted">共 {{ title_docs|length }} 篇文档</small>
                    </div>
                    <div class="card-body">
                        <table class="table table-striped doc-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>预览</th>
                                    <th>标签</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for doc in title_docs[:10] %}
                                <tr>
                                    <td>{{ doc.id[:8] }}</td>
                                    <td>
                                        <div class="doc-preview">{{ doc.text|truncate(100) }}</div>
                                    </td>
                                    <td>
                                        <div class="doc-tags">
                                            {% for tag in doc.tags %}
                                            <span class="doc-tag">{{ tag }}</span>
                                            {% endfor %}
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                                {% if title_docs|length > 10 %}
                                <tr>
                                    <td colspan="4" class="text-center">
                                        <em>显示前10篇文档 (共{{ title_docs|length }}篇)</em>
                                    </td>
                                </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
                {% endfor %}
            {% else %}
            <div class="text-center py-4">
                <p>该集合中还没有文档</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- 编辑集合模态框 -->
<div class="modal fade" id="editCollectionModal" tabindex="-1" aria-labelledby="editCollectionModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editCollectionModalLabel">编辑集合信息</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{{ url_for('edit_collection', collection_name=collection.name) }}" method="post">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="collectionName" class="form-label">集合名称</label>
                        <input type="text" class="form-control" id="collectionName" value="{{ collection.name }}" disabled>
                    </div>
                    <div class="mb-3">
                        <label for="description" class="form-label">描述</label>
                        <textarea class="form-control" id="description" name="description" rows="3">{{ collection.description }}</textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="submit" class="btn btn-primary">保存修改</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- 删除集合确认模态框 -->
<div class="modal fade" id="deleteCollectionModal" tabindex="-1" aria-labelledby="deleteCollectionModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteCollectionModalLabel">确认删除集合</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{{ url_for('delete_collection', collection_name=collection.name) }}" method="post" id="deleteForm">
                <div class="modal-body">
                    <p class="text-danger">警告：此操作将永久删除 <strong>{{ collection.name }}</strong> 集合及其所有文档！</p>
                    <p>此操作不可撤销。请输入集合名称以确认删除：</p>
                    <div class="mb-3">
                        <input type="text" class="form-control" id="confirmCollectionName" 
                               placeholder="输入集合名称确认" autocomplete="off">
                        <div class="form-text text-danger" id="nameMatchError" style="display: none;">
                            集合名称不匹配，请输入正确的名称
                        </div>
                    </div>
                    <!-- 隐藏的确认字段，会被JavaScript设置 -->
                    <input type="hidden" name="confirmed" id="confirmedField" value="false">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" onclick="confirmDelete()" class="btn btn-danger">删除集合</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // 初始化 DataTable
        try {
            let table = new DataTable('#documentsTable', {
                "language": {
                    "url": "//cdn.datatables.net/plug-ins/1.10.25/i18n/Chinese.json"
                },
                "pageLength": 10,
                "ordering": true,
                "order": [[0, 'asc']]
            });
        } catch (e) {
            console.log('DataTable初始化错误:', e);
        }
    });
    
    // 简化的删除确认函数
    function confirmDelete() {
        const confirmInput = document.getElementById('confirmCollectionName');
        const errorMsg = document.getElementById('nameMatchError');
        const confirmedField = document.getElementById('confirmedField');
        const form = document.getElementById('deleteForm');
        
        // 名称匹配检查
        if (confirmInput.value === '{{ collection.name }}') {
            confirmedField.value = 'true';
            form.submit();
        } else {
            // 显示错误
            errorMsg.style.display = 'block';
            confirmInput.classList.add('is-invalid');
        }
    }
    
    // 重置错误状态
    document.getElementById('confirmCollectionName').addEventListener('input', function() {
        this.classList.remove('is-invalid');
        document.getElementById('nameMatchError').style.display = 'none';
    });
</script>
{% endblock %} 