{% extends 'base.html' %}

{% block title %}Amphilagus - RAG Assistant{% endblock %}

{% block header %}RAG Assistant{% endblock %}
{% block subheader %}基于本地知识库的对话助手{% endblock %}

{% block head_extra %}
<style>
    .chat-container {
        height: 600px;
        overflow-y: auto;
        border-radius: 5px;
        padding: 15px;
        margin-bottom: 15px;
    }
    .message {
        margin-bottom: 15px;
        padding: 10px 15px;
        border-radius: 10px;
        max-width: 300%;
    }
    .user-message {
        margin-left: auto;
        text-align: right;
        word-wrap: break-word;
    }
    .assistant-message {
        margin-right: auto;
        word-wrap: break-word;
    }
    .template-badge {
        font-size: 0.7em;
        margin-left: 5px;
    }
    .message-avatar {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 10px;
        font-size: 14px;
    }
    .message-content {
        flex: 1;
    }
    .message-container {
        display: flex;
        align-items: flex-start;
    }
    .message-wrapper {
        display: flex;
        flex-direction: column;
        margin-bottom: 20px;
    }
    .assistant-wrapper {
        align-items: flex-start;
    }
    .user-wrapper {
        align-items: flex-end;
    }
    .message-time {
        font-size: 0.7em;
        margin-top: 2px;
    }
    .prompt-template-selector .form-check {
        padding: 10px;
        border-radius: 5px;
        margin-bottom: 10px;
        transition: all 0.2s;
    }
    .template-icon {
        font-size: 1.2em;
        margin-right: 5px;
    }
    .model-info {
        display: inline-block;
        margin-left: 10px;
        font-size: 0.9em;
    }
</style>
{% endblock %}

{% block content %}
<div class="row mt-2">
    <div class="col-md-3 mb-3">
        <!-- 配置面板 -->
        <div class="card">
            <div class="card-header py-2">
                <i class="fas fa-cog me-2"></i>配置
            </div>
            <div class="card-body">
                <form id="configForm" method="post" action="{{ url_for('rag_assistant_config') }}">
                    <!-- API Key 字段已移除，使用环境变量 -->
                    <div class="alert alert-info mb-3">
                        <i class="fas fa-info-circle me-2"></i>
                        使用环境变量中的 OPENAI_API_KEY 访问 OpenAI 服务
                    </div>

                    <!-- 集合选择 -->
                    <div class="mb-3">
                        <label for="collectionSelect" class="form-label">知识库集合</label>
                        <select class="form-select" id="collectionSelect" name="collection_name">
                            {% for collection in collections %}
                                <option value="{{ collection }}" {% if collection == current_collection %}selected{% endif %}>
                                    {{ collection }}
                                </option>
                            {% endfor %}
                        </select>
                        {% if collection_info and collection_info.exists %}
                            <div class="form-text text-success">该集合包含 {{ collection_info.count }} 个文档</div>
                        {% else %}
                            <div class="form-text text-warning">该集合不存在或为空</div>
                        {% endif %}
                    </div>

                    <!-- 模型选择 -->
                    <div class="mb-3">
                        <label for="modelSelect" class="form-label">LLM 模型</label>
                        <select class="form-select" id="modelSelect" name="llm_model">
                            <option value="gpt-4o-mini" {% if current_model == "gpt-4o-mini" %}selected{% endif %}>GPT-4o Mini (快速)</option>
                            <option value="gpt-3.5-turbo" {% if current_model == "gpt-3.5-turbo" %}selected{% endif %}>GPT-3.5 Turbo (快速)</option>
                            <option value="gpt-4o" {% if current_model == "gpt-4o" %}selected{% endif %}>GPT-4o (高质量)</option>
                        </select>
                    </div>

                    <!-- 提示词模板选择 -->
                    <div class="mb-3 prompt-template-selector">
                        <label class="form-label">提示词模板</label>
                        
                        <div class="form-check {% if current_template == 'precise' %}active{% endif %}">
                            <input class="form-check-input" type="radio" name="prompt_template" id="templatePrecise" 
                                   value="precise" {% if current_template == "precise" %}checked{% endif %}>
                            <label class="form-check-label" for="templatePrecise">
                                <span class="template-icon">🔍</span> 精准模式
                                <small class="d-block text-muted mt-1">严格遵循文档内容，提供简洁准确的回答</small>
                            </label>
                        </div>
                        
                        <div class="form-check {% if current_template == 'balanced' %}active{% endif %}">
                            <input class="form-check-input" type="radio" name="prompt_template" id="templateBalanced" 
                                   value="balanced" {% if current_template == "balanced" or not current_template %}checked{% endif %}>
                            <label class="form-check-label" for="templateBalanced">
                                <span class="template-icon">⚖️</span> 平衡模式
                                <small class="d-block text-muted mt-1">平衡准确性和流畅性，默认模式</small>
                            </label>
                        </div>
                        
                        <div class="form-check {% if current_template == 'creative' %}active{% endif %}">
                            <input class="form-check-input" type="radio" name="prompt_template" id="templateCreative" 
                                   value="creative" {% if current_template == "creative" %}checked{% endif %}>
                            <label class="form-check-label" for="templateCreative">
                                <span class="template-icon">🎨</span> 创意模式
                                <small class="d-block text-muted mt-1">在保持准确的同时提供更详细的解释和见解</small>
                            </label>
                        </div>
                    </div>

                    <!-- 初始化按钮 -->
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-sync-alt me-2"></i>初始化或更新
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-md-9">
        <!-- 聊天界面 -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center py-2">
                <div>
                    <i class="fas fa-comments me-2"></i>对话
                    {% if current_template %}
                        <span class="badge ms-2">
                            {% if current_template == 'precise' %}
                                🔍 精准模式
                            {% elif current_template == 'creative' %}
                                🎨 创意模式
                            {% else %}
                                ⚖️ 平衡模式
                            {% endif %}
                        </span>
                    {% endif %}
                </div>
                
                {% if initialized %}
                    <div class="model-info">
                        <span class="badge">
                            <i class="fas fa-robot me-1"></i>{{ current_model }}
                        </span>
                        
                        <!-- 添加清空历史按钮 -->
                        <form method="post" action="{{ url_for('rag_assistant_clear') }}" class="d-inline ms-2" id="clearHistoryForm" onsubmit="return confirm('确定要清空聊天历史吗？');">
                            <button type="submit" class="btn btn-sm btn-outline-secondary">
                                <i class="fas fa-trash-alt"></i> 清空历史
                            </button>
                        </form>
                    </div>
                {% endif %}
            </div>
            <div class="card-body p-0">
                {% if initialized %}
                    <div class="chat-container" id="chatContainer">
                        {% if chat_history %}
                            {% for message in chat_history %}
                                {% if message.role == 'user' %}
                                    <div class="message-wrapper user-wrapper">
                                        <div class="message-container">
                                            <div class="message-content">
                                                <div class="message user-message">
                                                    {{ message.content }}
                                                </div>
                                            </div>
                                            <div class="message-avatar user-avatar">
                                                <i class="fas fa-user"></i>
                                            </div>
                                        </div>
                                        <div class="message-time text-end">
                                            {{ message.timestamp|datetimeformat if message.timestamp else '' }}
                                        </div>
                                    </div>
                                {% else %}
                                    <div class="message-wrapper assistant-wrapper">
                                        <div class="message-container">
                                            <div class="message-avatar assistant-avatar">
                                                {% if message.template == 'precise' %}
                                                    🔍
                                                {% elif message.template == 'creative' %}
                                                    🎨
                                                {% else %}
                                                    ⚖️
                                                {% endif %}
                                            </div>
                                            <div class="message-content">
                                                <div class="message assistant-message">
                                                    {{ message.content|safe }}
                                                </div>
                                            </div>
                                        </div>
                                        <div class="message-time">
                                            {{ message.timestamp|datetimeformat if message.timestamp else '' }}
                                        </div>
                                    </div>
                                {% endif %}
                            {% endfor %}
                        {% else %}
                            <div class="text-center p-5 text-muted">
                                <i class="fas fa-comment-dots fa-3x mb-3"></i>
                                <p>开始提问来与您的知识库对话。</p>
                            </div>
                        {% endif %}
                    </div>
                    
                    <!-- 输入框 -->
                    <form id="chatForm" method="post" action="{{ url_for('rag_assistant_chat') }}" class="p-3 border-top">
                        <div class="input-group">
                            <input type="text" class="form-control" id="userQuery" name="user_query" 
                                   placeholder="输入您的问题..." required autocomplete="off">
                            <div class="input-group-prepend" style="margin-left: 8px; margin-right: 8px;">
                                <span class="input-group-text py-1 px-2" style="border-radius: 4px;">
                                    <label for="includeReferencesCheck" class="mb-0 me-2 small text-muted">
                                        <input type="checkbox" id="includeReferencesCheck" name="include_references" class="me-1" 
                                               title="显示参考文献列表">
                                        返回参考文献
                                    </label>
                                    <label for="topKInput" class="mb-0 me-1 small text-muted">检索数量:</label>
                                    <input type="number" class="form-control-sm border-0" id="topKInput" name="top_k" 
                                       min="1" max="100" value="{{ top_k }}" style="width: 50px;" title="检索文档数量">
                                </span>
                            </div>
                            <button class="btn btn-primary" type="submit">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </form>
                {% else %}
                    <div class="p-5 text-center">
                        <i class="fas fa-robot fa-4x mb-3 text-muted"></i>
                        <h5>请先初始化RAG助手</h5>111
                        <p class="text-muted">在左侧完成配置并点击"初始化或更新"按钮开始使用</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // 滚动到最新消息
        const chatContainer = document.getElementById('chatContainer');
        if (chatContainer) {
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
        
        // 提示词模板选择样式
        const templateRadios = document.querySelectorAll('.prompt-template-selector input[type="radio"]');
        templateRadios.forEach(radio => {
            radio.addEventListener('change', function() {
                document.querySelectorAll('.prompt-template-selector .form-check').forEach(check => {
                    check.classList.remove('active');
                });
                this.closest('.form-check').classList.add('active');
            });
        });
        
        // 记住参考文献复选框的状态
        const includeReferencesCheck = document.getElementById('includeReferencesCheck');
        if (includeReferencesCheck) {
            // 从localStorage加载状态
            const savedState = localStorage.getItem('includeReferencesState');
            if (savedState === 'true') {
                includeReferencesCheck.checked = true;
            }
            
            // 保存复选框状态到localStorage
            includeReferencesCheck.addEventListener('change', function() {
                localStorage.setItem('includeReferencesState', this.checked);
            });
        }
        
        // 记住检索数量设置
        const topKInput = document.getElementById('topKInput');
        if (topKInput) {
            // 从localStorage加载检索数量
            const savedTopK = localStorage.getItem('topKValue');
            if (savedTopK !== null) {
                topKInput.value = savedTopK;
            }
            
            // 当值变化时保存到localStorage
            topKInput.addEventListener('change', function() {
                localStorage.setItem('topKValue', this.value);
            });
            
            // 确保值在有效范围内
            topKInput.addEventListener('blur', function() {
                const value = parseInt(this.value);
                if (isNaN(value) || value < 1) {
                    this.value = 1;
                } else if (value > 100) {
                    this.value = 100;
                }
                localStorage.setItem('topKValue', this.value);
            });
        }
        
        // 聊天表单处理
        const chatForm = document.getElementById('chatForm');
        if (chatForm) {
            chatForm.addEventListener('submit', function(e) {
                const userInput = document.getElementById('userQuery');
                if (!userInput.value.trim()) {
                    e.preventDefault();
                }
                
                // 保存参考文献复选框状态，以便页面刷新后恢复
                if (includeReferencesCheck) {
                    localStorage.setItem('includeReferencesState', includeReferencesCheck.checked);
                }
                
                // 保存检索数量值
                if (topKInput) {
                    localStorage.setItem('topKValue', topKInput.value);
                }
                
                // 可以在这里添加提交时的加载动画
                if (userInput.value.trim()) {
                    // 显示加载状态
                    const submitBtn = this.querySelector('button[type="submit"]');
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';
                }
            });
        }
    });
</script>
{% endblock %} 