{% extends 'base.html' %}

{% block title %}Amphilagus - æ™ºèƒ½åŠ©æ‰‹{% endblock %}

{% block header %}æ™ºèƒ½åŠ©æ‰‹{% endblock %}
{% block subheader %}è¿™é‡Œæœ‰å¤šç§æ™ºèƒ½åŠ©æ‰‹ä¾›ä½ ä½¿ç”¨å’Œè°ƒè¯•{% endblock %}

{% block head_extra %}
<style>
    .agents-container {
        display: flex;
        flex-direction: column;
        height: 80vh;
        position: relative;
    }
    
    .agents-tabs {
        display: flex;
        overflow-x: auto;
        margin-bottom: 10px;
    }
    
    .agent-tab {
        padding: 8px 15px;
        margin-right: 5px;
        border-radius: 5px 5px 0 0;
        cursor: pointer;
        white-space: nowrap;
    }
    
    .agent-tab.active {
        font-weight: bold;
    }
    
    .agent-tab-close {
        margin-left: 8px;
        font-size: 14px;
    }
    
    .chat-area {
        flex: 1;
        display: flex;
        flex-direction: column;
        border-radius: 5px;
        overflow: hidden; /* Prevent overflow outside chat area */
    }
    
    .chat-container {
        flex: 1;
        overflow-y: auto;
        padding: 15px;
        margin-bottom: 0; /* Remove bottom margin since input is fixed */
        height: calc(80vh - 120px); /* Subtract height of input area + padding */
    }
    
    .message {
        margin-bottom: 15px;
        padding: 10px 15px;
        border-radius: 10px;
        max-width: 300%;
    }
    
    .user-message {
        margin-left: auto;
        text-align: left;
        word-wrap: break-word;
        max-width: 70%;
        width: fit-content;
    }
    
    .assistant-message {
        margin-right: auto;
        word-wrap: break-word;
        max-width: 70%;
    }
    
    .message-avatar {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 10px;
        font-size: 14px;
        flex-shrink: 0;
    }
    
    .message-content {
        flex: 1;
        min-width: 0; /* Ensures the flex item can shrink below its content size */
        overflow-wrap: break-word; /* Ensures words break to prevent overflow */
    }
    
    .message-container {
        display: flex;
        align-items: flex-start;
        width: 100%;
    }
    
    .user-message-container {
        display: flex;
        flex-direction: row-reverse;
        align-items: flex-start;
        width: 100%;
    }
    
    .user-message-container.text-end {
        justify-content: flex-end;
    }
    
    .user-avatar {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-left: 10px;
        font-size: 14px;
        flex-shrink: 0;
    }
    
    .message-wrapper {
        display: flex;
        flex-direction: column;
        margin-bottom: 20px;
        width: 100%;
    }
    
    .assistant-wrapper {
        align-items: flex-start;
    }
    
    .user-wrapper {
        align-items: flex-end;
    }
    
    .user-wrapper .message-time {
        text-align: right;
        width: 100%;
        padding-right: 40px; /* ä¸ºå¤´åƒé¢„ç•™çš„ç©ºé—´ */
    }
    
    .message-time {
        font-size: 0.7em;
        margin-top: 2px;
    }
    
    .input-container {
        display: flex;
        padding: 15px;
        background-color: inherit;
        border-top: 1px solid rgba(0,0,0,0.1);
        position: sticky;
        bottom: 0;
        left: 0;
        right: 0;
        z-index: 10;
    }
    
    .input-container textarea {
        flex: 1;
        resize: none;
        padding: 10px;
        border-radius: 5px;
    }
    
    .send-button {
        margin-left: 10px;
    }
    
    .agent-collection-badge {
        font-size: 0.75em;
        padding: 3px 6px;
        border-radius: 10px;
        margin-left: 8px;
    }
    
    .hidden {
        display: none;
    }
    
    /* å ä½æç¤º */
    .placeholder-message {
        text-align: center;
        padding: 40px 20px;
    }
    
    /* è°ƒè¯•é¢æ¿æ ·å¼ */
    .debug-panel {
        background-color: rgba(0, 0, 0, 0.03);
        border-radius: 5px;
        font-family: monospace;
        font-size: 0.9rem;
    }
    
    .debug-title {
        color: #6c757d;
        font-size: 0.9rem;
        margin-bottom: 8px;
        font-weight: bold;
    }
    
    .debug-content {
        max-height: 300px;
        overflow-y: auto;
    }
    
    .debug-step {
        padding: 5px;
        border-left: 3px solid #6c757d;
        background-color: rgba(0, 0, 0, 0.02);
    }
    
    .debug-json {
        font-size: 0.8rem;
        white-space: pre-wrap;
        margin: 0;
        color: #333;
    }
    
    .debug-message {
        white-space: pre-wrap;
        color: #333;
    }

    /* åŠ©æ‰‹ç±»å‹é€‰æ‹©æ ·å¼ */
    .assistant-type-selector {
        margin-bottom: 15px;
    }
    
    .assistant-type-selector .form-check {
        margin-bottom: 10px;
        padding: 10px;
        border-radius: 5px;
        border: 1px solid rgba(0,0,0,0.1);
        transition: all 0.3s ease;
    }
    
    .assistant-type-selector .form-check:hover {
        background-color: rgba(0,0,0,0.03);
    }
    
    .assistant-type-selector .form-check-input:checked + .form-check-label {
        font-weight: bold;
    }
    
    .assistant-type-description {
        font-size: 0.9em;
        color: #6c757d;
        margin-top: 5px;
    }

    /* Markdown æ ·å¼ */
    .assistant-message pre {
        background-color: rgba(0, 0, 0, 0.04);
        border-radius: 4px;
        padding: 10px;
        overflow-x: auto;
    }

    .assistant-message code {
        background-color: rgba(0, 0, 0, 0.04);
        border-radius: 3px;
        padding: 2px 4px;
        font-family: Consolas, Monaco, 'Andale Mono', monospace;
    }

    .assistant-message blockquote {
        border-left: 4px solid #ddd;
        padding-left: 10px;
        margin-left: 20px;
        color: #666;
    }

    .assistant-message table {
        border-collapse: collapse;
        width: 100%;
        margin-bottom: 1rem;
    }

    .assistant-message table th,
    .assistant-message table td {
        padding: 8px;
        border: 1px solid #ddd;
    }

    .assistant-message table th {
        background-color: rgba(0, 0, 0, 0.04);
        font-weight: bold;
    }
</style>
<!-- é¢„å…ˆåŠ è½½ Marked.js åº“ -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
{% endblock %}

{% block content %}
<div class="row mt-2">
    <div class="col-md-3 mb-3">
        <!-- åˆ›å»ºæ–°æ™ºèƒ½åŠ©æ‰‹é¢æ¿ -->
        <div class="card">
            <div class="card-header py-2">
                <i class="fas fa-robot me-2"></i>åˆ›å»ºæ™ºèƒ½åŠ©æ‰‹
            </div>
            <div class="card-body">
                <form id="createAgentForm">
                    <!-- åŠ©æ‰‹ç±»å‹é€‰æ‹© -->
                    <div class="mb-3 assistant-type-selector">
                        <label class="form-label">åŠ©æ‰‹ç±»å‹</label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="assistantType" id="typeQA" value="qa" checked>
                            <label class="form-check-label" for="typeQA">
                                <i class="fas fa-robot me-1"></i> é—®ç­”åŠ©æ‰‹
                            </label>
                            <div class="assistant-type-description">
                                ä¸æ–‡æ¡£é›†åˆè¿›è¡Œæ™ºèƒ½å¯¹è¯ï¼Œè·å–ç²¾å‡†å›ç­”
                            </div>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="assistantType" id="typeRef" value="reference">
                            <label class="form-check-label" for="typeRef">
                                <i class="fas fa-quote-right me-1"></i> å¼•ç”¨åŠ©æ‰‹
                            </label>
                            <div class="assistant-type-description">
                                ä¸ºå­¦æœ¯é™ˆè¿°è‡ªåŠ¨æ·»åŠ ç›¸å…³æ–‡çŒ®å¼•ç”¨
                            </div>
                        </div>
                    </div>

                    <!-- é›†åˆé€‰æ‹© -->
                    <div class="mb-3">
                        <label for="collectionSelect" class="form-label">çŸ¥è¯†åº“é›†åˆ</label>
                        <select class="form-select" id="collectionSelect" name="collection_name" required>
                            <option value="" selected disabled>é€‰æ‹©é›†åˆ</option>
                            {% for collection in collections %}
                                <option value="{{ collection }}">{{ collection }}</option>
                            {% endfor %}
                        </select>
                        <div class="form-text">é€‰æ‹©åŒ…å«æ–‡æ¡£çš„é›†åˆ</div>
                    </div>

                    <!-- æ¨¡å‹é€‰æ‹© -->
                    <div class="mb-3">
                        <label for="agentModel" class="form-label">æ¨¡å‹</label>
                        <select class="form-select" id="agentModel">
                            <option value="gpt-4.1-2025-04-14" selected>GPT-4.1 (å…ˆè¿›)</option>
                            <option value="gpt-4o-mini">GPT-4o Mini (å¿«é€Ÿ)</option>
                            <option value="gpt-4o">GPT-4o (ç»å…¸)</option>
                        </select>
                    </div>
                    
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="agentDebugMode">
                        <label class="form-check-label" for="agentDebugMode">è°ƒè¯•æ¨¡å¼</label>
                    </div>
                    
                    <!-- ç»“æœæ•°é‡ -->
                    <div class="mb-3">
                        <label for="topKInput" class="form-label">ç»“æœæ•°é‡ (top_k)</label>
                        <input type="number" class="form-control" id="topKInput" name="top_k" value="21" min="1" max="100">
                        <div class="form-text">æ¯æ¬¡æŸ¥è¯¢è¿”å›çš„æœ€å¤§æ–‡æ¡£æ•°é‡</div>
                    </div>

                    <!-- åŠ©æ‰‹åç§° -->
                    <div class="mb-3">
                        <label for="agentNameInput" class="form-label">åŠ©æ‰‹åç§° (å¯é€‰)</label>
                        <input type="text" class="form-control" id="agentNameInput" name="agent_name" placeholder="è‡ªåŠ¨åŸºäºé›†åˆå‘½å">
                    </div>

                    <!-- åˆ›å»ºæŒ‰é’® -->
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary" id="createAgentBtn">
                            <i class="fas fa-plus me-2"></i>åˆ›å»ºåŠ©æ‰‹
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-md-9">
        <!-- æ™ºèƒ½åŠ©æ‰‹å¯¹è¯ç•Œé¢ -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center py-2">
                <div>
                    <i class="fas fa-comments me-2"></i>æ™ºèƒ½åŠ©æ‰‹å¯¹è¯
                </div>
                <div id="currentAgentInfo" class="d-flex align-items-center">
                    <div class="placeholder-message text-muted small">
                        <span>è¯·åˆ›å»ºæˆ–é€‰æ‹©ä¸€ä¸ªæ™ºèƒ½åŠ©æ‰‹</span>
                    </div>
                </div>
                <div>
                    <button type="button" class="btn btn-sm btn-outline-secondary" id="clearChatBtn">
                        <i class="fas fa-trash-alt"></i> æ¸…ç©ºå½“å‰å¯¹è¯
                    </button>
                </div>
            </div>
            <div class="card-body p-0">
                <!-- åŠ©æ‰‹é€‰é¡¹å¡ -->
                <div class="agents-tabs" id="agentTabs"></div>
                
                <!-- åŠ©æ‰‹ç•Œé¢ -->
                <div class="agents-container">
                    <div class="chat-area" id="chatArea">
                        <div class="placeholder-message text-muted" id="noAgentPlaceholder">
                            <i class="fas fa-robot fa-3x mb-3"></i>
                            <p>è¯·åˆ›å»ºä¸€ä¸ªæ–°æ™ºèƒ½åŠ©æ‰‹å¼€å§‹å¯¹è¯</p>
                            <p class="small">ä½¿ç”¨å·¦ä¾§é¢æ¿åˆ›å»ºåŸºäºä¸åŒæ–‡æ¡£é›†åˆçš„æ™ºèƒ½åŠ©æ‰‹</p>
                        </div>
                    </div>
                    
                    <!-- è¾“å…¥åŒºåŸŸ -->
                    <div class="input-container" id="chatInputContainer">
                        <textarea 
                            class="form-control" 
                            id="userInput" 
                            placeholder="è¾“å…¥æ‚¨çš„é—®é¢˜..." 
                            rows="2"
                            disabled
                        ></textarea>
                        <button class="btn btn-primary send-button" type="button" id="sendMessageBtn" disabled>
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript ä»£ç  -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // å…¨å±€å˜é‡
        const agents = {};  // ä¿å­˜åŠ©æ‰‹ä¿¡æ¯çš„å¯¹è±¡
        let activeAgentId = null;  // å½“å‰æ´»åŠ¨åŠ©æ‰‹ID
        
        // å®šä¹‰toggleDebugInfoå‡½æ•°åœ¨å…¨å±€ä½œç”¨åŸŸ
        window.toggleDebugInfo = function(debugId) {
            const debugElement = document.getElementById(debugId);
            if (debugElement) {
                if (debugElement.style.display === 'none') {
                    debugElement.style.display = 'block';
                } else {
                    debugElement.style.display = 'none';
                }
            }
        };

        // DOM å…ƒç´ 
        const agentTabs = document.getElementById('agentTabs');
        const chatArea = document.getElementById('chatArea');
        const createAgentForm = document.getElementById('createAgentForm');
        const userInput = document.getElementById('userInput');
        const sendMessageBtn = document.getElementById('sendMessageBtn');
        const clearChatBtn = document.getElementById('clearChatBtn');
        const noAgentPlaceholder = document.getElementById('noAgentPlaceholder');
        const currentAgentInfo = document.getElementById('currentAgentInfo');
        const assistantTypeRadios = document.getElementsByName('assistantType');
        
        // åŠ©æ‰‹ç±»å‹åˆ‡æ¢å¤„ç†
        function updatePlaceholder() {
            const selectedType = document.querySelector('input[name="assistantType"]:checked').value;
            if (selectedType === 'reference') {
                userInput.placeholder = "è¾“å…¥æ‚¨çš„å­¦æœ¯é™ˆè¿°ï¼Œç³»ç»Ÿå°†ä¸ºå…¶æ·»åŠ å¼•ç”¨...";
            } else {
                userInput.placeholder = "è¾“å…¥æ‚¨çš„é—®é¢˜...";
            }
        }
        
        // ç›‘å¬åŠ©æ‰‹ç±»å‹åˆ‡æ¢
        assistantTypeRadios.forEach(radio => {
            radio.addEventListener('change', updatePlaceholder);
        });
        
        // åˆ›å»ºæ–°åŠ©æ‰‹
        createAgentForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // è·å–è¡¨å•æ•°æ®
            const formData = new FormData(createAgentForm);
            const collectionName = formData.get('collection_name');
            const model = document.getElementById('agentModel').value;
            const topK = formData.get('top_k');
            let agentName = formData.get('agent_name');
            const debugMode = document.getElementById('agentDebugMode').checked;
            const assistantType = document.querySelector('input[name="assistantType"]:checked').value;
            
            // å¦‚æœæœªæä¾›åç§°ï¼Œä½¿ç”¨é›†åˆåç§°
            if (!agentName || agentName.trim() === '') {
                agentName = collectionName;
            }
            
            // ç”Ÿæˆå”¯ä¸€ID
            const agentId = 'agent_' + Date.now();
            
            // åˆ›å»ºæ–°åŠ©æ‰‹
            createAgent(agentId, agentName, collectionName, model, topK, debugMode, assistantType);
            
            // é‡ç½®è¡¨å•
            // ä¸é‡ç½®åŠ©æ‰‹ç±»å‹é€‰æ‹©
            document.getElementById('collectionSelect').value = '';
            document.getElementById('agentNameInput').value = '';
            document.getElementById('agentDebugMode').checked = false;
            
            // æç¤ºç”¨æˆ·
            showToast('æ™ºèƒ½åŠ©æ‰‹åˆ›å»ºæˆåŠŸ', 'success');
        });
        
        // å‘é€æ¶ˆæ¯
        sendMessageBtn.addEventListener('click', sendMessage);
        
        // æŒ‰Enteré”®å‘é€æ¶ˆæ¯
        userInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        
        // æ¸…ç©ºå½“å‰å¯¹è¯
        clearChatBtn.addEventListener('click', function() {
            if (activeAgentId && confirm('ç¡®å®šè¦æ¸…ç©ºå½“å‰å¯¹è¯å—ï¼Ÿ')) {
                const chatContainer = document.getElementById(`chat_${activeAgentId}`);
                if (chatContainer) {
                    // ä¿ç•™æ¬¢è¿æ¶ˆæ¯
                    const welcomeMsg = chatContainer.querySelector('.welcome-message');
                    chatContainer.innerHTML = '';
                    if (welcomeMsg) {
                        chatContainer.appendChild(welcomeMsg);
                    }
                    
                    // æ¸…ç©ºæ¶ˆæ¯å†å²
                    agents[activeAgentId].messages = [];
                    
                    showToast('å¯¹è¯å·²æ¸…ç©º', 'success');
                }
            }
        });
        
        // æ»šåŠ¨åˆ°åº•éƒ¨
        function scrollToBottom(container) {
            if (container) {
                container.scrollTop = container.scrollHeight;
            }
        }
        
        // åˆ›å»ºæ–°æ™ºèƒ½åŠ©æ‰‹
        function createAgent(agentId, agentName, collectionName, model, topK, debugMode, assistantType) {
            // å­˜å‚¨åŠ©æ‰‹ä¿¡æ¯
            agents[agentId] = {
                id: agentId,
                name: agentName,
                collection: collectionName,
                model: model,
                topK: topK,
                messages: [],
                debugMode: debugMode,
                assistantType: assistantType
            };
            
            // åˆ›å»ºæ ‡ç­¾
            const tab = document.createElement('div');
            tab.className = 'agent-tab';
            tab.id = `tab_${agentId}`;
            tab.innerHTML = `
                ${agentName}
                <span class="agent-collection-badge">${collectionName}</span>
                <span class="agent-tab-close" data-agent-id="${agentId}">Ã—</span>
            `;
            agentTabs.appendChild(tab);
            
            // æ ‡ç­¾ç‚¹å‡»äº‹ä»¶
            tab.addEventListener('click', function(e) {
                // å¿½ç•¥å…³é—­æŒ‰é’®çš„ç‚¹å‡»
                if (e.target.classList.contains('agent-tab-close')) {
                    return;
                }
                activateAgent(agentId);
            });
            
            // å…³é—­æ ‡ç­¾äº‹ä»¶
            tab.querySelector('.agent-tab-close').addEventListener('click', function() {
                removeAgent(agentId);
            });
            
            // åˆ›å»ºèŠå¤©å®¹å™¨
            const chatContainer = document.createElement('div');
            chatContainer.className = 'chat-container hidden';
            chatContainer.id = `chat_${agentId}`;
            
            // æ·»åŠ æ¬¢è¿æ¶ˆæ¯
            const welcomeMessage = document.createElement('div');
            welcomeMessage.className = 'message-wrapper assistant-wrapper welcome-message';
            
            // æ ¹æ®åŠ©æ‰‹ç±»å‹è®¾ç½®ä¸åŒçš„æ¬¢è¿ä¿¡æ¯
            let welcomeText = "";
            if (assistantType === 'reference') {
                welcomeText = `æˆ‘æ˜¯åŸºäº ${collectionName} é›†åˆçš„å¼•ç”¨åŠ©æ‰‹ï¼Œå¯ä»¥ä¸ºå­¦æœ¯é™ˆè¿°æ·»åŠ ç›¸å…³æ–‡çŒ®å¼•ç”¨ã€‚`;
            } else {
                welcomeText = `æˆ‘æ˜¯åŸºäº ${collectionName} é›†åˆçš„æ™ºèƒ½åŠ©æ‰‹ï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®æ‚¨çš„å—ï¼Ÿ`;
            }
            
            welcomeMessage.innerHTML = `
                <div class="message-container">
                    <div class="message-avatar">ğŸ¤–</div>
                    <div class="message-content assistant-message">
                        <div>${welcomeText}</div>
                    </div>
                </div>
                <div class="message-time">${getCurrentTime()}</div>
            `;
            chatContainer.appendChild(welcomeMessage);
            chatArea.appendChild(chatContainer);
            
            // æ¿€æ´»æ–°åˆ›å»ºçš„åŠ©æ‰‹
            activateAgent(agentId);
            
            // å¯ç”¨è¾“å…¥æ¡†
            userInput.disabled = false;
            sendMessageBtn.disabled = false;
            
            // éšè—å ä½æ¶ˆæ¯
            noAgentPlaceholder.classList.add('hidden');
            
            // æ»šåŠ¨åˆ°åº•éƒ¨
            scrollToBottom(chatContainer);
        }
        
        // æ¿€æ´»åŠ©æ‰‹
        function activateAgent(agentId) {
            // å¦‚æœå·²æœ‰æ´»åŠ¨åŠ©æ‰‹ï¼Œå…ˆåœç”¨
            if (activeAgentId) {
                document.getElementById(`tab_${activeAgentId}`).classList.remove('active');
                document.getElementById(`chat_${activeAgentId}`).classList.add('hidden');
            }
            
            // æ¿€æ´»æ–°åŠ©æ‰‹
            activeAgentId = agentId;
            document.getElementById(`tab_${agentId}`).classList.add('active');
            document.getElementById(`chat_${agentId}`).classList.remove('hidden');
            
            // æ›´æ–°å½“å‰åŠ©æ‰‹ä¿¡æ¯
            updateAgentInfo(agentId);
            
            // æ ¹æ®åŠ©æ‰‹ç±»å‹æ›´æ–°è¾“å…¥æ¡†æç¤º
            const agent = agents[agentId];
            if (agent.assistantType === 'reference') {
                userInput.placeholder = "è¾“å…¥æ‚¨çš„å­¦æœ¯é™ˆè¿°ï¼Œç³»ç»Ÿå°†ä¸ºå…¶æ·»åŠ å¼•ç”¨...";
            } else {
                userInput.placeholder = "è¾“å…¥æ‚¨çš„é—®é¢˜...";
            }
            
            // èšç„¦è¾“å…¥æ¡†
            userInput.focus();
        }
        
        // æ›´æ–°åŠ©æ‰‹ä¿¡æ¯é¢æ¿
        function updateAgentInfo(agentId) {
            const agent = agents[agentId];
            if (!agent) return;
            
            // æ˜¾ç¤ºåŠ©æ‰‹ç±»å‹æ ‡å¿—
            const typeLabel = agent.assistantType === 'reference' ? 
                '<span class="badge bg-info">å¼•ç”¨åŠ©æ‰‹</span>' : 
                '<span class="badge bg-primary">é—®ç­”åŠ©æ‰‹</span>';
            
            currentAgentInfo.innerHTML = `
                <div class="d-flex gap-2 align-items-center">
                    <span>${agent.name} ${typeLabel}</span>
                    <span class="badge bg-primary">é›†åˆ: ${agent.collection}</span>
                    <span class="badge bg-secondary">æ¨¡å‹: ${agent.model}</span>
                    <span class="badge bg-info">ç»“æœæ•°é‡: ${agent.topK}</span>
                    ${agent.debugMode ? '<span class="badge bg-warning">è°ƒè¯•æ¨¡å¼</span>' : ''}
                </div>
            `;
        }
        
        // ç§»é™¤åŠ©æ‰‹
        function removeAgent(agentId) {
            if (!confirm('ç¡®å®šè¦å…³é—­è¿™ä¸ªæ™ºèƒ½åŠ©æ‰‹å—ï¼Ÿ')) {
                return;
            }
            
            // ç§»é™¤æ ‡ç­¾å’ŒèŠå¤©å®¹å™¨
            document.getElementById(`tab_${agentId}`).remove();
            document.getElementById(`chat_${agentId}`).remove();
            
            // ä»å­˜å‚¨ä¸­ç§»é™¤
            delete agents[agentId];
            
            // å¦‚æœç§»é™¤çš„æ˜¯å½“å‰æ´»åŠ¨åŠ©æ‰‹
            if (agentId === activeAgentId) {
                // æ‰¾åˆ°ä¸‹ä¸€ä¸ªå¯ç”¨çš„åŠ©æ‰‹
                const remainingIds = Object.keys(agents);
                if (remainingIds.length > 0) {
                    activateAgent(remainingIds[0]);
                } else {
                    // æ²¡æœ‰å‰©ä½™åŠ©æ‰‹
                    activeAgentId = null;
                    userInput.disabled = true;
                    sendMessageBtn.disabled = true;
                    noAgentPlaceholder.classList.remove('hidden');
                    currentAgentInfo.innerHTML = `
                        <div class="placeholder-message text-muted small">
                            <span>è¯·åˆ›å»ºæˆ–é€‰æ‹©ä¸€ä¸ªæ™ºèƒ½åŠ©æ‰‹</span>
                        </div>
                    `;
                }
            }
        }
        
        // å‘é€æ¶ˆæ¯
        function sendMessage() {
            const text = userInput.value.trim();
            if (!text || !activeAgentId) return;
            
            const agent = agents[activeAgentId];
            const chatContainer = document.getElementById(`chat_${activeAgentId}`);
            
            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°UI
            const userMessageElem = document.createElement('div');
            userMessageElem.className = 'message-wrapper user-wrapper';
            
            // åˆ¤æ–­æ˜¯å•è¡Œè¿˜æ˜¯å¤šè¡Œæ¶ˆæ¯
            const isSingleLine = !text.includes('\n') && text.length < 80; // å¤§çº¦80ä¸ªå­—ç¬¦ä½œä¸ºå•è¡Œçš„åˆ¤æ–­æ ‡å‡†
            
            userMessageElem.innerHTML = `
                <div class="user-message-container ${isSingleLine ? 'text-end' : ''}">
                    <div class="user-avatar">ğŸ‘¤</div>
                    <div class="message-content user-message ${isSingleLine ? 'text-end' : ''}">
                        ${text}
                    </div>
                </div>
                <div class="message-time">${getCurrentTime()}</div>
            `;
            chatContainer.appendChild(userMessageElem);
            
            // å¤„ç†æ¶ˆæ¯
            processMessage(text, agent.collection, agent.model, agent.topK, agent.debugMode, agent.assistantType);
            
            // æ»šåŠ¨åˆ°åº•éƒ¨
            scrollToBottom(chatContainer);
        }
        
        // è·å–å½“å‰æ—¶é—´
        function getCurrentTime() {
            return new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
        }
        
        // æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
        function showToast(message, type = 'info') {
            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨toastå®¹å™¨
            let toastContainer = document.getElementById('toastContainer');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.id = 'toastContainer';
                toastContainer.className = 'toast-container position-fixed bottom-0 end-0 p-3';
                document.body.appendChild(toastContainer);
            }
            
            // åˆ›å»ºtoastå…ƒç´ 
            const toastId = 'toast-' + Date.now();
            const toast = document.createElement('div');
            toast.className = `toast align-items-center text-white bg-${type} border-0`;
            toast.id = toastId;
            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            `;
            
            toastContainer.appendChild(toast);
            
            // åˆå§‹åŒ–å¹¶æ˜¾ç¤ºtoast
            const toastObj = new bootstrap.Toast(toast, {
                autohide: true,
                delay: 3000
            });
            toastObj.show();
            
            // ç›‘å¬å…³é—­äº‹ä»¶ï¼Œç§»é™¤DOMå…ƒç´ 
            toast.addEventListener('hidden.bs.toast', function () {
                toast.remove();
            });
        }
        
        // å¤„ç†æ¶ˆæ¯å‡½æ•°
        function processMessage(text, collectionName, model, topK, debugMode, assistantType) {
            // æ¸…ç©ºè¾“å…¥æ¡†
            userInput.value = '';
            
            // è·å–èŠå¤©å®¹å™¨
            const chatContainer = document.getElementById(`chat_${activeAgentId}`);
            
            // æ·»åŠ æ€è€ƒä¸­æç¤º
            const thinkingElem = document.createElement('div');
            thinkingElem.id = 'thinking-message';
            thinkingElem.className = 'message-wrapper assistant-wrapper';
            thinkingElem.innerHTML = `
                <div class="message-container">
                    <div class="message-avatar">ğŸ¤–</div>
                    <div class="message-content assistant-message">
                        <div class="thinking"><i class="fas fa-spinner fa-spin me-2"></i>æ€è€ƒä¸­...</div>
                    </div>
                </div>
                <div class="message-time">${getCurrentTime()}</div>
            `;
            chatContainer.appendChild(thinkingElem);
            scrollToBottom(chatContainer);
            
            // æ ¹æ®åŠ©æ‰‹ç±»å‹é€‰æ‹©APIç«¯ç‚¹
            const apiEndpoint = assistantType === 'reference' ? 
                '/agent_assistant/collection_ref' : 
                '/agent_assistant/collection_qa';
            
            // å‘é€åˆ°åç«¯
            fetch(apiEndpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    agent_id: activeAgentId,
                    query: text,
                    collection_name: collectionName,
                    model: model,
                    top_k: topK,
                    debug_mode: debugMode === true // ç¡®ä¿ä¼ é€’å¸ƒå°”å€¼è€Œä¸æ˜¯å…¶ä»–ç±»å‹
                })
            })
            .then(response => response.json())
            .then(data => {
                // ç§»é™¤æ€è€ƒä¸­æç¤º
                document.getElementById('thinking-message').remove();
                
                // å¤„ç†è¿”å›ç»“æœ
                if (data.error) {
                    // æ˜¾ç¤ºé”™è¯¯
                    const errorElem = document.createElement('div');
                    errorElem.className = 'message-wrapper assistant-wrapper';
                    errorElem.innerHTML = `
                        <div class="message-container">
                            <div class="message-avatar">ğŸ¤–</div>
                            <div class="message-content assistant-message">
                                <div class="text-danger">é”™è¯¯: ${data.error}</div>
                            </div>
                        </div>
                        <div class="message-time">${getCurrentTime()}</div>
                    `;
                    chatContainer.appendChild(errorElem);
                } else {
                    // æ˜¾ç¤ºå›å¤
                    const response = data.response;
                    let responseHTML = '';
                    
                    // æ— è®ºæ˜¯å¦ä¸ºè°ƒè¯•æ¨¡å¼ï¼Œéƒ½ä½¿ç”¨ç›¸åŒçš„é€»è¾‘å¤„ç†å›å¤
                    if (typeof response === 'object') {
                        // å¦‚æœè¿”å›çš„æ˜¯å¯¹è±¡ï¼Œæ˜¾ç¤ºresponseå­—æ®µ
                        responseHTML = response.response || JSON.stringify(response);
                    } else {
                        // å¦‚æœè¿”å›çš„æ˜¯å­—ç¬¦ä¸²ï¼Œç›´æ¥æ˜¾ç¤º
                        responseHTML = response;
                    }
                    
                    // æ·»åŠ å›å¤åˆ°UI
                    const replyElem = document.createElement('div');
                    replyElem.className = 'message-wrapper assistant-wrapper';
                    
                    // å¦‚æœå“åº”æ˜¯Markdownæ ¼å¼ï¼Œä½¿ç”¨marked.jsæ¸²æŸ“
                    if (data.is_markdown) {
                        replyElem.innerHTML = `
                            <div class="message-container">
                                <div class="message-avatar">ğŸ¤–</div>
                                <div class="message-content assistant-message">
                                    <div id="markdown-content-${Date.now()}"></div>
                                </div>
                            </div>
                            <div class="message-time">${getCurrentTime()}</div>
                        `;
                        chatContainer.appendChild(replyElem);
                        
                        // åŠ¨æ€åŠ è½½marked.jsåº“ï¼ˆå¦‚æœå°šæœªåŠ è½½ï¼‰
                        if (typeof marked === 'undefined') {
                            const script = document.createElement('script');
                            script.src = 'https://cdn.jsdelivr.net/npm/marked/marked.min.js';
                            script.onload = () => {
                                // åº“åŠ è½½å®Œæˆåæ¸²æŸ“Markdown
                                const markdownContainer = replyElem.querySelector('[id^="markdown-content-"]');
                                if (markdownContainer) {
                                    markdownContainer.innerHTML = marked.parse(responseHTML);
                                }
                            };
                            document.head.appendChild(script);
                        } else {
                            // åº“å·²åŠ è½½ï¼Œç›´æ¥æ¸²æŸ“
                            const markdownContainer = replyElem.querySelector('[id^="markdown-content-"]');
                            if (markdownContainer) {
                                markdownContainer.innerHTML = marked.parse(responseHTML);
                            }
                        }
                    } else {
                        // å¸¸è§„HTMLå†…å®¹
                        replyElem.innerHTML = `
                            <div class="message-container">
                                <div class="message-avatar">ğŸ¤–</div>
                                <div class="message-content assistant-message">
                                    <div>${responseHTML}</div>
                                </div>
                            </div>
                            <div class="message-time">${getCurrentTime()}</div>
                        `;
                        chatContainer.appendChild(replyElem);
                    }
                }
                
                // è®°å½•æ¶ˆæ¯åˆ°å†å²
                if (activeAgentId && agents[activeAgentId]) {
                    agents[activeAgentId].messages.push({
                        role: 'user',
                        content: text,
                        timestamp: new Date()
                    });
                    
                    agents[activeAgentId].messages.push({
                        role: 'assistant',
                        content: data.response || data.error,
                        timestamp: new Date()
                    });
                }
                
                // æ»šåŠ¨åˆ°åº•éƒ¨
                scrollToBottom(chatContainer);
            })
            .catch(error => {
                // ç§»é™¤æ€è€ƒä¸­æç¤º
                const thinkingMsg = document.getElementById('thinking-message');
                if (thinkingMsg) thinkingMsg.remove();
                
                // æ˜¾ç¤ºé”™è¯¯
                const errorElem = document.createElement('div');
                errorElem.className = 'message-wrapper assistant-wrapper';
                errorElem.innerHTML = `
                    <div class="message-container">
                        <div class="message-avatar">ğŸ¤–</div>
                        <div class="message-content assistant-message">
                            <div class="text-danger">ç³»ç»Ÿé”™è¯¯: ${error.message}</div>
                        </div>
                    </div>
                    <div class="message-time">${getCurrentTime()}</div>
                `;
                chatContainer.appendChild(errorElem);
                scrollToBottom(chatContainer);
                console.error('Error:', error);
            });
        }
    });
</script>
{% endblock %}