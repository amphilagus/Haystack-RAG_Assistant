{% extends 'base.html' %}

{% block title %}Amphilagus - RAG Assistant{% endblock %}

{% block header %}RAG Assistant{% endblock %}
{% block subheader %}åŸºäºæœ¬åœ°çŸ¥è¯†åº“çš„å¯¹è¯åŠ©æ‰‹{% endblock %}

{% block head_extra %}
<style>
    .chat-container {
        height: 600px;
        overflow-y: auto;
        border-radius: 5px;
        padding: 15px;
        margin-bottom: 15px;
    }
    .message {
        margin-bottom: 15px;
        padding: 10px 15px;
        border-radius: 10px;
        max-width: 300%;
    }
    .user-message {
        margin-left: auto;
        text-align: right;
        word-wrap: break-word;
    }
    .assistant-message {
        margin-right: auto;
        word-wrap: break-word;
    }
    .template-badge {
        font-size: 0.7em;
        margin-left: 5px;
    }
    .message-avatar {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 10px;
        font-size: 14px;
    }
    .message-content {
        flex: 1;
    }
    .message-container {
        display: flex;
        align-items: flex-start;
    }
    .message-wrapper {
        display: flex;
        flex-direction: column;
        margin-bottom: 20px;
    }
    .assistant-wrapper {
        align-items: flex-start;
    }
    .user-wrapper {
        align-items: flex-end;
    }
    .message-time {
        font-size: 0.7em;
        margin-top: 2px;
    }
    .prompt-template-selector .form-check {
        padding: 10px;
        border-radius: 5px;
        margin-bottom: 10px;
        transition: all 0.2s;
    }
    .template-icon {
        font-size: 1.2em;
        margin-right: 5px;
    }
    .model-info {
        display: inline-block;
        margin-left: 10px;
        font-size: 0.9em;
    }
</style>
{% endblock %}

{% block content %}
<div class="row mt-2">
    <div class="col-md-3 mb-3">
        <!-- é…ç½®é¢æ¿ -->
        <div class="card">
            <div class="card-header py-2">
                <i class="fas fa-cog me-2"></i>é…ç½®
            </div>
            <div class="card-body">
                <form id="configForm" method="post" action="{{ url_for('rag_assistant_config') }}">
                    <!-- API Key å­—æ®µå·²ç§»é™¤ï¼Œä½¿ç”¨ç¯å¢ƒå˜é‡ -->
                    <div class="alert alert-info mb-3">
                        <i class="fas fa-info-circle me-2"></i>
                        ä½¿ç”¨ç¯å¢ƒå˜é‡ä¸­çš„ OPENAI_API_KEY è®¿é—® OpenAI æœåŠ¡
                    </div>

                    <!-- é›†åˆé€‰æ‹© -->
                    <div class="mb-3">
                        <label for="collectionSelect" class="form-label">çŸ¥è¯†åº“é›†åˆ</label>
                        <select class="form-select" id="collectionSelect" name="collection_name">
                            {% for collection in collections %}
                                <option value="{{ collection }}" {% if collection == current_collection %}selected{% endif %}>
                                    {{ collection }}
                                </option>
                            {% endfor %}
                        </select>
                        {% if collection_info and collection_info.exists %}
                            <div class="form-text text-success">è¯¥é›†åˆåŒ…å« {{ collection_info.count }} ä¸ªæ–‡æ¡£</div>
                        {% else %}
                            <div class="form-text text-warning">è¯¥é›†åˆä¸å­˜åœ¨æˆ–ä¸ºç©º</div>
                        {% endif %}
                    </div>

                    <!-- æ¨¡å‹é€‰æ‹© -->
                    <div class="mb-3">
                        <label for="modelSelect" class="form-label">LLM æ¨¡å‹</label>
                        <select class="form-select" id="modelSelect" name="llm_model">
                            <option value="gpt-4o-mini" {% if current_model == "gpt-4o-mini" %}selected{% endif %}>GPT-4o Mini (å¿«é€Ÿ)</option>
                            <option value="gpt-3.5-turbo" {% if current_model == "gpt-3.5-turbo" %}selected{% endif %}>GPT-3.5 Turbo (å¿«é€Ÿ)</option>
                            <option value="gpt-4o" {% if current_model == "gpt-4o" %}selected{% endif %}>GPT-4o (é«˜è´¨é‡)</option>
                        </select>
                    </div>

                    <!-- æç¤ºè¯æ¨¡æ¿é€‰æ‹© -->
                    <div class="mb-3 prompt-template-selector">
                        <label class="form-label">æç¤ºè¯æ¨¡æ¿</label>
                        
                        <div class="form-check {% if current_template == 'precise' %}active{% endif %}">
                            <input class="form-check-input" type="radio" name="prompt_template" id="templatePrecise" 
                                   value="precise" {% if current_template == "precise" %}checked{% endif %}>
                            <label class="form-check-label" for="templatePrecise">
                                <span class="template-icon">ğŸ”</span> ç²¾å‡†æ¨¡å¼
                                <small class="d-block text-muted mt-1">ä¸¥æ ¼éµå¾ªæ–‡æ¡£å†…å®¹ï¼Œæä¾›ç®€æ´å‡†ç¡®çš„å›ç­”</small>
                            </label>
                        </div>
                        
                        <div class="form-check {% if current_template == 'balanced' %}active{% endif %}">
                            <input class="form-check-input" type="radio" name="prompt_template" id="templateBalanced" 
                                   value="balanced" {% if current_template == "balanced" or not current_template %}checked{% endif %}>
                            <label class="form-check-label" for="templateBalanced">
                                <span class="template-icon">âš–ï¸</span> å¹³è¡¡æ¨¡å¼
                                <small class="d-block text-muted mt-1">å¹³è¡¡å‡†ç¡®æ€§å’Œæµç•…æ€§ï¼Œé»˜è®¤æ¨¡å¼</small>
                            </label>
                        </div>
                        
                        <div class="form-check {% if current_template == 'creative' %}active{% endif %}">
                            <input class="form-check-input" type="radio" name="prompt_template" id="templateCreative" 
                                   value="creative" {% if current_template == "creative" %}checked{% endif %}>
                            <label class="form-check-label" for="templateCreative">
                                <span class="template-icon">ğŸ¨</span> åˆ›æ„æ¨¡å¼
                                <small class="d-block text-muted mt-1">åœ¨ä¿æŒå‡†ç¡®çš„åŒæ—¶æä¾›æ›´è¯¦ç»†çš„è§£é‡Šå’Œè§è§£</small>
                            </label>
                        </div>
                    </div>

                    <!-- åˆå§‹åŒ–æŒ‰é’® -->
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-sync-alt me-2"></i>åˆå§‹åŒ–æˆ–æ›´æ–°
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-md-9">
        <!-- èŠå¤©ç•Œé¢ -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center py-2">
                <div>
                    <i class="fas fa-comments me-2"></i>å¯¹è¯
                    {% if current_template %}
                        <span class="badge ms-2">
                            {% if current_template == 'precise' %}
                                ğŸ” ç²¾å‡†æ¨¡å¼
                            {% elif current_template == 'creative' %}
                                ğŸ¨ åˆ›æ„æ¨¡å¼
                            {% else %}
                                âš–ï¸ å¹³è¡¡æ¨¡å¼
                            {% endif %}
                        </span>
                    {% endif %}
                </div>
                
                {% if initialized %}
                    <div class="model-info">
                        <span class="badge">
                            <i class="fas fa-robot me-1"></i>{{ current_model }}
                        </span>
                        
                        <!-- æ·»åŠ æ¸…ç©ºå†å²æŒ‰é’® -->
                        <form method="post" action="{{ url_for('rag_assistant_clear') }}" class="d-inline ms-2" id="clearHistoryForm" onsubmit="return confirm('ç¡®å®šè¦æ¸…ç©ºèŠå¤©å†å²å—ï¼Ÿ');">
                            <button type="submit" class="btn btn-sm btn-outline-secondary">
                                <i class="fas fa-trash-alt"></i> æ¸…ç©ºå†å²
                            </button>
                        </form>
                    </div>
                {% endif %}
            </div>
            <div class="card-body p-0">
                {% if initialized %}
                    <div class="chat-container" id="chatContainer">
                        {% if chat_history %}
                            {% for message in chat_history %}
                                {% if message.role == 'user' %}
                                    <div class="message-wrapper user-wrapper">
                                        <div class="message-container">
                                            <div class="message-content">
                                                <div class="message user-message">
                                                    {{ message.content }}
                                                </div>
                                            </div>
                                            <div class="message-avatar user-avatar">
                                                <i class="fas fa-user"></i>
                                            </div>
                                        </div>
                                        <div class="message-time text-end">
                                            {{ message.timestamp|datetimeformat if message.timestamp else '' }}
                                        </div>
                                    </div>
                                {% else %}
                                    <div class="message-wrapper assistant-wrapper">
                                        <div class="message-container">
                                            <div class="message-avatar assistant-avatar">
                                                {% if message.template == 'precise' %}
                                                    ğŸ”
                                                {% elif message.template == 'creative' %}
                                                    ğŸ¨
                                                {% else %}
                                                    âš–ï¸
                                                {% endif %}
                                            </div>
                                            <div class="message-content">
                                                <div class="message assistant-message">
                                                    {{ message.content|safe }}
                                                </div>
                                            </div>
                                        </div>
                                        <div class="message-time">
                                            {{ message.timestamp|datetimeformat if message.timestamp else '' }}
                                        </div>
                                    </div>
                                {% endif %}
                            {% endfor %}
                        {% else %}
                            <div class="text-center p-5 text-muted">
                                <i class="fas fa-comment-dots fa-3x mb-3"></i>
                                <p>å¼€å§‹æé—®æ¥ä¸æ‚¨çš„çŸ¥è¯†åº“å¯¹è¯ã€‚</p>
                            </div>
                        {% endif %}
                    </div>
                    
                    <!-- è¾“å…¥æ¡† -->
                    <form id="chatForm" method="post" action="{{ url_for('rag_assistant_chat') }}" class="p-3 border-top">
                        <div class="input-group">
                            <input type="text" class="form-control" id="userQuery" name="user_query" 
                                   placeholder="è¾“å…¥æ‚¨çš„é—®é¢˜..." required autocomplete="off">
                            <div class="input-group-prepend" style="margin-left: 8px; margin-right: 8px;">
                                <span class="input-group-text py-1 px-2" style="border-radius: 4px;">
                                    <label for="includeReferencesCheck" class="mb-0 me-2 small text-muted">
                                        <input type="checkbox" id="includeReferencesCheck" name="include_references" class="me-1" 
                                               title="æ˜¾ç¤ºå‚è€ƒæ–‡çŒ®åˆ—è¡¨">
                                        è¿”å›å‚è€ƒæ–‡çŒ®
                                    </label>
                                    <label for="topKInput" class="mb-0 me-1 small text-muted">æ£€ç´¢æ•°é‡:</label>
                                    <input type="number" class="form-control-sm border-0" id="topKInput" name="top_k" 
                                       min="1" max="100" value="{{ top_k }}" style="width: 50px;" title="æ£€ç´¢æ–‡æ¡£æ•°é‡">
                                </span>
                            </div>
                            <button class="btn btn-primary" type="submit">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </form>
                {% else %}
                    <div class="p-5 text-center">
                        <i class="fas fa-robot fa-4x mb-3 text-muted"></i>
                        <h5>è¯·å…ˆåˆå§‹åŒ–RAGåŠ©æ‰‹</h5>111
                        <p class="text-muted">åœ¨å·¦ä¾§å®Œæˆé…ç½®å¹¶ç‚¹å‡»"åˆå§‹åŒ–æˆ–æ›´æ–°"æŒ‰é’®å¼€å§‹ä½¿ç”¨</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // æ»šåŠ¨åˆ°æœ€æ–°æ¶ˆæ¯
        const chatContainer = document.getElementById('chatContainer');
        if (chatContainer) {
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
        
        // æç¤ºè¯æ¨¡æ¿é€‰æ‹©æ ·å¼
        const templateRadios = document.querySelectorAll('.prompt-template-selector input[type="radio"]');
        templateRadios.forEach(radio => {
            radio.addEventListener('change', function() {
                document.querySelectorAll('.prompt-template-selector .form-check').forEach(check => {
                    check.classList.remove('active');
                });
                this.closest('.form-check').classList.add('active');
            });
        });
        
        // è®°ä½å‚è€ƒæ–‡çŒ®å¤é€‰æ¡†çš„çŠ¶æ€
        const includeReferencesCheck = document.getElementById('includeReferencesCheck');
        if (includeReferencesCheck) {
            // ä»localStorageåŠ è½½çŠ¶æ€
            const savedState = localStorage.getItem('includeReferencesState');
            if (savedState === 'true') {
                includeReferencesCheck.checked = true;
            }
            
            // ä¿å­˜å¤é€‰æ¡†çŠ¶æ€åˆ°localStorage
            includeReferencesCheck.addEventListener('change', function() {
                localStorage.setItem('includeReferencesState', this.checked);
            });
        }
        
        // è®°ä½æ£€ç´¢æ•°é‡è®¾ç½®
        const topKInput = document.getElementById('topKInput');
        if (topKInput) {
            // ä»localStorageåŠ è½½æ£€ç´¢æ•°é‡
            const savedTopK = localStorage.getItem('topKValue');
            if (savedTopK !== null) {
                topKInput.value = savedTopK;
            }
            
            // å½“å€¼å˜åŒ–æ—¶ä¿å­˜åˆ°localStorage
            topKInput.addEventListener('change', function() {
                localStorage.setItem('topKValue', this.value);
            });
            
            // ç¡®ä¿å€¼åœ¨æœ‰æ•ˆèŒƒå›´å†…
            topKInput.addEventListener('blur', function() {
                const value = parseInt(this.value);
                if (isNaN(value) || value < 1) {
                    this.value = 1;
                } else if (value > 100) {
                    this.value = 100;
                }
                localStorage.setItem('topKValue', this.value);
            });
        }
        
        // èŠå¤©è¡¨å•å¤„ç†
        const chatForm = document.getElementById('chatForm');
        if (chatForm) {
            chatForm.addEventListener('submit', function(e) {
                const userInput = document.getElementById('userQuery');
                if (!userInput.value.trim()) {
                    e.preventDefault();
                }
                
                // ä¿å­˜å‚è€ƒæ–‡çŒ®å¤é€‰æ¡†çŠ¶æ€ï¼Œä»¥ä¾¿é¡µé¢åˆ·æ–°åæ¢å¤
                if (includeReferencesCheck) {
                    localStorage.setItem('includeReferencesState', includeReferencesCheck.checked);
                }
                
                // ä¿å­˜æ£€ç´¢æ•°é‡å€¼
                if (topKInput) {
                    localStorage.setItem('topKValue', topKInput.value);
                }
                
                // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ æäº¤æ—¶çš„åŠ è½½åŠ¨ç”»
                if (userInput.value.trim()) {
                    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                    const submitBtn = this.querySelector('button[type="submit"]');
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';
                }
            });
        }
    });
</script>
{% endblock %} 